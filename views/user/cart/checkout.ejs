<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <style>
        .payment-option {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .payment-option.selected {
            border-color: #0d6efd;
            background-color: #f8f9ff;
        }
        .product-img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
        }
        .form-check-input:checked {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
    </style>
</head>
<body class="bg-light">
    <%- include('../userHeader.ejs') %>
    <div class="container py-5">
        <div class="row g-4">
            <!-- Checkout Form -->
            <div class="col-lg-8">
                <!-- Shipping Address -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0" >Shipping Address</h5>
                            <a href="/user/shippingAddress" class="btn btn-outline-primary btn-sm">Edit</a>
                        </div>
                        <% user.addresses.forEach(address => { %> 
                            <% if(address.isDefault){ %>
                            <div id="address" class="mb-3">
                                <strong><%= address.name %></strong><br>
                                <%= address.address %>, <%= address.city %>, <%= address.state %> <%= address.zip %>, <%= address.country %><br>
                                Phone Number: <%= address.phone %>
                            </div>

                      <% } }) %>
                        <!-- <div class="mb-3">
                            <strong>Muhammed Nabeel C</strong><br>
                            Micro Grafix, Theriveed, Road, Kozhikode, KERALA 673032, India<br>
                            Phone Number: 7558663319
                        </div> -->
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="sameAddress" checked>
                            <label class="form-check-label" for="sameAddress" >
                                Billing Address is same as shipping address
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Payment Options -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="mb-4">Payment Option</h5>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="payment-option selected text-center">
                                    <img src="/api/placeholder/40/40" alt="Cash" class="mb-2">
                                    <div>Cash on Delivery</div>
                                    <input type="radio" name="payment" checked class="visually-hidden">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="payment-option text-center">
                                    <img src="/api/placeholder/40/40" alt="Razorpay" class="mb-2">
                                    <div>Razorpay</div>
                                    <input type="radio" name="payment" class="visually-hidden">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="payment-option text-center">
                                    <img src="/api/placeholder/40/40" alt="Wallet" class="mb-2">
                                    <div>My Wallet</div>
                                    <input type="radio" name="payment" class="visually-hidden">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Additional Information -->
                <div class="card">
                    <div class="card-body">
                        <h5 class="mb-3">Additional Information</h5>
                        <div class="mb-3">
                            <label class="form-label text-muted">Order Notes (Optional)</label>
                            <textarea id="notes" class="form-control" rows="3" placeholder="Notes about your order, e.g. special notes for delivery"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="mb-4">Order Summary</h5>
                        <% let total = 0;
                        let discount = 0; %>
                        <% if(cart){  %>
                            <% cart.products.forEach(product=>{ %>
                                <% if(product.quantity !=0 ){ %>
                       <p><%= product.productId.name%></p>
                        <!-- Product 1 -->
                        <div class="d-flex mb-3 .cart-item">
                            <img src="<%=  product.productId.productImageUrls[0] %>" alt="Camera" class="product-img me-3">
                            <div class="flex-grow-1">
                                <h6 class="mb-0"><%= product.productId.name%></h6>
                                <small class="text-muted"><span class="quantity"><%= product.quantity%></span> × <span class="price">₹ <%= product.productId.sellingPrice %></span></small>
                            </div>
                        </div>
                        <%  total += product.productId.sellingPrice *  product.quantity %>
                        <%  discount += (Number( product.productId.regularPrice )- Number( product.productId.sellingPrice)) *  product.quantity %>
                        <% }})} %>
                        <!-- Product 2 -->
                        <!-- <div class="d-flex mb-4">
                            <img src="/api/placeholder/60/60" alt="Headphones" class="product-img me-3">
                            <div class="flex-grow-1">
                                <h6 class="mb-0">Wired Over-Ear Gaming Headphones with U...</h6>
                                <small class="text-muted">3 × $250</small>
                            </div>
                        </div> -->

                        <hr>

                        <!-- Order Details -->
                        <div class="mb-2 d-flex justify-content-between">
                            <span>Sub-total</span>
                          
                            <span>₹ <%=Math.ceil( total) %> </span>
                        </div>
                        <div class="mb-2 d-flex justify-content-between">
                            <span>Shipping</span>
                            <span class="text-success">Free</span>
                        </div>
                        <div class="mb-2 d-flex justify-content-between">
                            <span>Discount</span>
                            <span>₹ -<%=Math.ceil(  discount) %></span>
                        </div>
                        <div class="mb-4 d-flex justify-content-between">
                            <span>Tax</span>
                            <span>₹ <%= Math.ceil( total *.18)%></span>
                        </div>
                        <div class="mb-4 d-flex justify-content-between">
                            <span>Coupon</span>
                            <span>₹- <%= 0%></span>
                        </div>

                        <div class="d-flex justify-content-between mb-4">
                            <strong>Total</strong>
                            <strong>₹ <%=    Math.ceil( (total *.18) + total)%></strong>
                        </div>
                        <div class="d-flex justify-content-between mb-4">
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="Coupon Code">
                                <button class="btn btn-outline-dark">Apply</button>
                            </div>
                        </div>
    

                        <button id="placeOrderBtn" class="btn btn-dark w-100">Place Order</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
<%- include('../userFooter.ejs') %>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


    <script>
        // place order
        const placeOrderBtn = document.querySelector('#placeOrderBtn');
        placeOrderBtn.addEventListener('click', () => {
            // validate form
            // address
            
            // payment option
            // additional information
            // submit form
            const notes = document.getElementById('notes').value;
            const address = document.getElementById("address").innerText;
            console.log(notes)

            fetch('/user/order/placeOrder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    products: `<%= JSON.stringify(cart.products) %>`,
                    total: `<%= Math.ceil( (total *.18) + total) %>`,
                    discount: `<%= Math.ceil(  discount) %>`,
                    tax: `<%= Math.ceil( total *.18) %>`,
                    shipping: 0,
                    payment: 'Cash on Delivery',
                    notes,
                    address: address,
                })
            }).then(response => response.json())
            .then(data => {
                if(data.success){
                            Swal.fire({
                        title: 'Sweet!',
                        text: 'Order placed successfully !',
                        icon: 'success',
                        confirmButtonText: 'Cool'
                    }).then(() => {
                        window.location.href = '/user/orders';
                    });
                }else{
                    Swal.fire({
                        title: 'Oops...',
                        text: data.message,
                        icon: 'error',
                        confirmButtonText: 'Cool'
                    }).then(() => {
                        window.location.href = '/user/cart';
                    });;
                }
            })
             

        });
        
    </script>
</body>
</html>